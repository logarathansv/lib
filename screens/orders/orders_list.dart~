import 'package:flutter/material.dart';
import 'package:hugeicons/hugeicons.dart';
import 'package:sklyit_business/screens/orders/add_orders_page.dart';
import '../../models/customer_model/customer_class.dart';
import '../../models/order_model/order_model.dart';
import '../../models/product_model/product_model.dart'; // Import the Product class
import '../../models/service_model/service_model.dart';
import '../../providers/order_provider.dart';
import '../../providers/product_provider.dart';
import '../../providers/service_provider.dart';
import 'order_details.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class AddOrdersPage extends ConsumerStatefulWidget {
  final bool autoTriggerAddOrder;

  const AddOrdersPage({super.key, this.autoTriggerAddOrder = false});

  @override
  ConsumerState<AddOrdersPage> createState() => _AddOrdersPageState();
}

class _AddOrdersPageState extends ConsumerState<AddOrdersPage> {
  // Sample orders data
   List<Order> orders = [];

  final _searchController = TextEditingController();
  List<Customer> customers = [];
  List<Service> services = [];
  List<Product> products = [];
  List<Order> _searchResults = [];
  String _filterType = 'All'; // Default filter

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) => getOrders());
    WidgetsBinding.instance.addPostFrameCallback((_) => getServices());
    WidgetsBinding.instance.addPostFrameCallback((_) => getProducts());
    WidgetsBinding.instance.addPostFrameCallback((_) => getCustomers());
    if (widget.autoTriggerAddOrder) {
      WidgetsBinding.instance.addPostFrameCallback((_) {
        _navigateToAddOrderPage();
      });
    }
  }

  void getOrders() async{
    final ordersAsync = ref.watch(getOrdersProvider);
    ordersAsync.when(
      data: (fetchedOrders){
        setState(() {
          orders=fetchedOrders;
        });
      },
      error: (error,stackTrace){
        print("Error Loading orders: $error");
        return [];
      },
      loading:
      ()=>CircularProgressIndicator(),
    );
    print('orders: $orders');
  }

  void getServices() async{
    final servicesAsync = ref.watch(getServicesProvider);
    servicesAsync.when(
      data: (fetchedServices){
        setState(() {
          services=fetchedServices;
        });
      },
      error: (error,stackTrace){
        print("Error Loading services: $error");
        return [];
      },
      loading:
      ()=>CircularProgressIndicator(),
    );
  }

  void getProducts() async{
    final productsAsync = ref.watch(getProductsProvider);
    productsAsync.when(
      data: (fetchedProducts){
        setState(() {
          products=fetchedProducts;
        });
      },
      error: (error,stackTrace){
        print("Error Loading products: $error");
        return [];
      },
      loading:
      ()=>CircularProgressIndicator(),
    );
  }

  void getCustomers() async{
    // final customersAsync = ref.watch(getCustomersProvider);
    // customersAsync.when(
    //   data: (fetchedCustomers){
    //     setState(() {
    //       customers=fetchedCustomers;
    //     });
    //   },
    //   error: (error,stackTrace){
    //     print("Error Loading customers: $error");
    //     return [];
    //   },
    //   loading:
    //   ()=>CircularProgressIndicator(),
    // );
  }


  void _navigateToAddOrderPage() async {
    final newOrder = await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => AddOrderPage(
          services: services,
          products: products,
          existingCustomers: customers,
        ),
      ),
    );

    if (newOrder != null) {
      setState(() {
        orders.add(newOrder);
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: const Color(0xfff4c345),
        automaticallyImplyLeading: false,
        leading: IconButton(
          onPressed: () => {Navigator.of(context).pop()},
          icon: const HugeIcon(
            icon: HugeIcons.strokeRoundedArrowLeft03,
            color: Colors.black,
            size: 24.0,
          ),
        ),
        title: const Text(
          'Orders',
          style: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.bold,
            color: Color(0xFF2f4757),
          ),
        ),
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // Search Bar
            _buildSearchBar(),
            const SizedBox(height: 16),

            // Filter Tags
            SizedBox(
              height: 40,
              child: ListView(
                scrollDirection: Axis.horizontal,
                children: [
                  _buildFilterTag('All'),
                  _buildFilterTag('Recent'),
                  _buildFilterTag('Old'),
                  _buildFilterTag('Amount: Low to High'),
                  _buildFilterTag('Amount: High to Low'),
                  _buildFilterTag('Date: Oldest First'),
                  _buildFilterTag('Date: Newest First'),
                ],
              ),
            ),
            const SizedBox(height: 16),

            // Add Order Button
            ElevatedButton.icon(
              onPressed: () async {
                // Navigate to the AddOrderPage
                final newOrder = await Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (context) => AddOrderPage(
                      services: services,
                      products: products, // Pass the products list
                      existingCustomers: customers,
                    ),
                  ),
                );

                // If a new order is returned, add it to the list
                if (newOrder != null) {
                  setState(() {
                    orders.add(newOrder);
                  });
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF2f4757),
                padding: const EdgeInsets.symmetric(vertical: 12),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              icon: const Icon(Icons.add, color: Colors.white),
              label: const Text(
                'Add Order',
                style: TextStyle(color: Colors.white),
              ),
            ),
            const SizedBox(height: 16),

            // Orders List
            Expanded(
              child: ListView.builder(
                itemCount: _searchResults.isEmpty
                    ? _getFilteredOrders().length
                    : _searchResults.length,
                itemBuilder: (context, index) {
                  final order = _searchResults.isEmpty
                      ? _getFilteredOrders()[index]
                      : _searchResults[index];
                  return GestureDetector(
                    onTap: () => {
                      Navigator.push(
                        context,
                        PageRouteBuilder(
                          pageBuilder:
                              (context, animation, secondaryAnimation) =>
                                  OrderDetailsPage(order: order),
                          transitionDuration: const Duration(milliseconds: 200),
                          transitionsBuilder:
                              (context, animation, secondaryAnimation, child) {
                            return SlideTransition(
                              position: Tween<Offset>(
                                begin: const Offset(1, 0),
                                end: const Offset(0, 0),
                              ).animate(animation),
                              child: child,
                            );
                          },
                        ),
                      )
                    },
                    child: _buildOrderCard(order, context),
                  );
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  // Search Bar
  Widget _buildSearchBar() {
    return Container(
      decoration: BoxDecoration(
        color: Colors.grey[200],
        borderRadius: BorderRadius.circular(25),
      ),
      child: TextField(
        controller: _searchController,
        decoration: const InputDecoration(
          border: InputBorder.none,
          hintText: "Search... ",
          prefixIcon: Icon(Icons.search),
          contentPadding: EdgeInsets.symmetric(horizontal: 20, vertical: 20),
        ),
        onChanged: (text) => {_searchOrders()},
      ),
    );
  }

  // Build a filter tag
  Widget _buildFilterTag(String label) {
    return GestureDetector(
      onTap: () {
        setState(() {
          _filterType = label;
        });
      },
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 4),
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color:
              _filterType == label ? const Color(0xfff4c345) : Colors.grey[300],
          borderRadius: BorderRadius.circular(20),
        ),
        child: Text(
          label,
          style: TextStyle(
            color: _filterType == label ? Colors.white : Colors.black,
            fontWeight: FontWeight.bold,
          ),
        ),
      ),
    );
  }

  // Filter orders based on the selected filter type
  List<Order> _getFilteredOrders() {
    // return orders;
    switch (_filterType) {
      case 'Recent':
        return orders
            .where((order) => DateTime.parse(order.orderDate)
                .isAfter(DateTime.now().subtract(Duration(days: 7))))
            .toList();
      case 'Old':
        return orders
            .where((order) => DateTime.parse(order.orderDate)
                .isBefore(DateTime.now().subtract(Duration(days: 7))))
            .toList();
      case 'Amount: Low to High':
        return List.from(orders)..sort((a, b) => a.totalAmount.compareTo(b.totalAmount));
      case 'Amount: High to Low':
        return List.from(orders)..sort((a, b) => b.totalAmount.compareTo(a.totalAmount));
      case 'Date: Oldest First':
        return List.from(orders)
          ..sort((a, b) => DateTime.parse(a.orderDate).compareTo(DateTime.parse(b.orderDate)));
      case 'Date: Newest First':
        return List.from(orders)
          ..sort((a, b) => DateTime.parse(b.orderDate).compareTo(DateTime.parse(a.orderDate)));
      default:
        return orders;
    }
  }

  // Search orders
  void _searchOrders() {
    setState(() {
      _searchResults = _getFilteredOrders()
          .where((order) =>
              order.customerName
                  .toLowerCase()
                  .contains(_searchController.text.toLowerCase()) ||
              order.totalAmount.contains(_searchController.text) ||
              order.orderDate
                  .toString()
                  .contains(_searchController.text))
          .toList();
    });
  }

  // Order Card
  Widget _buildOrderCard(Order order, BuildContext context) {
    return Card(
      elevation: 2,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
      margin: const EdgeInsets.symmetric(vertical: 8),
      child: Padding(
        padding: const EdgeInsets.all(12.0),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            // Order Details
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(
                      order.services.first as String,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: Color(0xFF2f4757),
                      ),
                    ),
                    if (order.services.length > 1)
                      Text(
                        ' and ${order.services.length - 1} more',
                        style: const TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: Color(0xFF2f4757),
                        ),
                      ),
                  ],
                ),
                const SizedBox(height: 4),
                Text(
                  order.customerName,
                  style: const TextStyle(color: Color(0xFF028F83)),
                ),
                if (order.products.isNotEmpty)
                  Text(
                    'Products: ${order.products.length}',
                    style: const TextStyle(color: Colors.grey),
                  ),
              ],
            ),
            // Action Icons
            Row(
              children: [
                IconButton(
                  icon: const HugeIcon(
                    icon: HugeIcons.strokeRoundedArrowRightDouble,
                    color: Colors.black,
                    size: 24.0,
                  ),
                  onPressed: () {
                    Navigator.push(
                      context,
                      PageRouteBuilder(
                        pageBuilder: (context, animation, secondaryAnimation) =>
                            OrderDetailsPage(order: order),
                        transitionDuration: const Duration(milliseconds: 200),
                        transitionsBuilder:
                            (context, animation, secondaryAnimation, child) {
                          return SlideTransition(
                            position: Tween<Offset>(
                              begin: const Offset(1, 0),
                              end: const Offset(0, 0),
                            ).animate(animation),
                            child: child,
                          );
                        },
                      ),
                    );
                  },
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

}
